# Keepa - Go å®šæ—¶ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ

ä¸€ä¸ªä½¿ç”¨ Go è¯­è¨€æ„å»ºçš„é«˜æ€§èƒ½ã€å¯æ‰©å±•çš„å®šæ—¶ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿã€‚

## ç‰¹æ€§

- ğŸš€ **é«˜æ€§èƒ½**: åŸºäº `robfig/cron` çš„è½»é‡çº§è°ƒåº¦å¼•æ“
- ğŸ”§ **æ˜“æ‰©å±•**: æ¸…æ™°çš„ä»»åŠ¡æ¥å£ï¼Œæ–¹ä¾¿æ·»åŠ æ–°ä»»åŠ¡
- ğŸ“ **ç»“æ„åŒ–æ—¥å¿—**: åŸºäº zap çš„é«˜æ€§èƒ½æ—¥å¿—ç³»ç»Ÿ
- âš™ï¸ **çµæ´»é…ç½®**: æ”¯æŒ YAML é…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡
- ğŸ›¡ï¸ **ä¼˜é›…å…³é—­**: æ”¯æŒä¼˜é›…çš„å…³é—­å’Œèµ„æºæ¸…ç†
- â±ï¸ **è¶…æ—¶æ§åˆ¶**: æ”¯æŒä»»åŠ¡çº§åˆ«çš„è¶…æ—¶æ§åˆ¶
- ğŸŒ **æ—¶åŒºæ”¯æŒ**: æ”¯æŒè‡ªå®šä¹‰æ—¶åŒº
- ğŸ’¾ **å¤šæ•°æ®åº“æ”¯æŒ**: åŒæ—¶æ”¯æŒ MySQLã€PostgreSQL å’Œ MongoDB

## é¡¹ç›®ç»“æ„

```
keepa/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ keepa/          # åº”ç”¨ç¨‹åºå…¥å£
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ config/         # é…ç½®ç®¡ç†
â”‚   â”‚   â””â”€â”€ config.go
â”‚   â”œâ”€â”€ database/       # æ•°æ®åº“è¿æ¥ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ database.go
â”‚   â”‚   â”œâ”€â”€ global.go
â”‚   â”‚   â””â”€â”€ helper.go
â”‚   â”œâ”€â”€ logger/         # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”‚   â””â”€â”€ logger.go
â”‚   â”œâ”€â”€ scheduler/      # è°ƒåº¦å™¨æ ¸å¿ƒ
â”‚   â”‚   â””â”€â”€ scheduler.go
â”‚   â”œâ”€â”€ task/           # ä»»åŠ¡æ¥å£å’Œæ³¨å†Œ
â”‚   â”‚   â”œâ”€â”€ task.go
â”‚   â”‚   â””â”€â”€ errors.go
â”‚   â””â”€â”€ tasks/          # å…·ä½“ä»»åŠ¡å®ç°
â”‚       â”œâ”€â”€ example.go
â”‚       â””â”€â”€ db_example.go
â”œâ”€â”€ configs/            # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ config.yaml
â”œâ”€â”€ go.mod
â”œâ”€â”€ Makefile
â””â”€â”€ README.md
```

## å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
make deps
# æˆ–
go mod download
```

### è¿è¡Œåº”ç”¨

```bash
make run
# æˆ–
go run cmd/keepa/main.go
```

### æ„å»ºåº”ç”¨

```bash
make build
```

## é…ç½®è¯´æ˜

é…ç½®æ–‡ä»¶ä½äº `configs/config.yaml`ï¼Œæ”¯æŒä»¥ä¸‹é…ç½®é¡¹ï¼š

- `app`: åº”ç”¨åŸºç¡€é…ç½®ï¼ˆåç§°ã€ç‰ˆæœ¬ã€ç¯å¢ƒï¼‰
- `scheduler`: è°ƒåº¦å™¨é…ç½®ï¼ˆé»˜è®¤è¶…æ—¶ã€æ—¶åŒºï¼‰
- `logger`: æ—¥å¿—é…ç½®ï¼ˆçº§åˆ«ã€æ ¼å¼ã€æ–‡ä»¶è·¯å¾„ç­‰ï¼‰

### ç¯å¢ƒå˜é‡

é…ç½®ä¹Ÿå¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®ï¼Œç¯å¢ƒå˜é‡å‰ç¼€ä¸º `KEEPA_`ï¼Œä¾‹å¦‚ï¼š

```bash
export KEEPA_APP_ENV=production
export KEEPA_LOGGER_LEVEL=debug
```

## æ·»åŠ æ–°ä»»åŠ¡

### 1. å®ç° Task æ¥å£

åœ¨ `internal/tasks/` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„ä»»åŠ¡æ–‡ä»¶ï¼š

```go
package tasks

import (
    "context"
    "time"
    "keepa/internal/task"
)

type MyTask struct {
    name    string
    enabled bool
}

func NewMyTask() task.Task {
    return &MyTask{
        name:    "my_task",
        enabled: true,
    }
}

func (t *MyTask) Name() string {
    return t.name
}

func (t *MyTask) Schedule() string {
    // Cron è¡¨è¾¾å¼: ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨
    // ä¾‹å¦‚: "0 */10 * * * *" è¡¨ç¤ºæ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    return "0 */10 * * * *"
}

func (t *MyTask) Run(ctx context.Context) error {
    // å®ç°ä»»åŠ¡é€»è¾‘
    // ctx ç”¨äºå–æ¶ˆå’Œè¶…æ—¶æ§åˆ¶
    return nil
}

func (t *MyTask) Timeout() time.Duration {
    // è¿”å› 0 ä½¿ç”¨é»˜è®¤è¶…æ—¶æ—¶é—´
    return 0
}

func (t *MyTask) Enabled() bool {
    return t.enabled
}
```

### 2. æ³¨å†Œä»»åŠ¡

åœ¨ `cmd/keepa/main.go` çš„ `registerTasks` å‡½æ•°ä¸­æ³¨å†Œæ–°ä»»åŠ¡ï¼š

```go
func registerTasks(registry *task.TaskRegistry) error {
    // ... å…¶ä»–ä»»åŠ¡æ³¨å†Œ
    
    if err := registry.Register(tasks.NewMyTask()); err != nil {
        return fmt.Errorf("failed to register my task: %w", err)
    }
    
    return nil
}
```

## Cron è¡¨è¾¾å¼

æ”¯æŒæ ‡å‡†çš„ cron è¡¨è¾¾å¼æ ¼å¼ï¼ˆæ”¯æŒç§’çº§ç²¾åº¦ï¼‰ï¼š

```
ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨
* * * * * *
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€ æ˜ŸæœŸå‡  (0-6, 0=æ˜ŸæœŸæ—¥)
â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€ æœˆä»½ (1-12)
â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€ æ—¥æœŸ (1-31)
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ (0-23)
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ (0-59)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç§’ (0-59)
```

ç¤ºä¾‹ï¼š
- `0 */5 * * * *` - æ¯5åˆ†é’Ÿæ‰§è¡Œ
- `0 0 */2 * * *` - æ¯2å°æ—¶æ‰§è¡Œ
- `0 0 0 * * *` - æ¯å¤©åˆå¤œæ‰§è¡Œ
- `0 0 9 * * 1-5` - å·¥ä½œæ—¥ä¸Šåˆ9ç‚¹æ‰§è¡Œ

## æ•°æ®åº“æ”¯æŒ

æœ¬é¡¹ç›®æ”¯æŒåŒæ—¶è¿æ¥ MySQLã€PostgreSQL å’Œ MongoDB ä¸‰ç§æ•°æ®åº“ã€‚æ‰€æœ‰æ•°æ®åº“è¿æ¥éƒ½æ˜¯å¯é€‰çš„ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦å¯ç”¨ç›¸åº”çš„æ•°æ®åº“ã€‚

### é…ç½®æ•°æ®åº“

åœ¨ `configs/config.yaml` ä¸­é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼š

```yaml
database:
  mysql:
    enabled: true
    host: localhost
    port: 3306
    username: root
    password: your_password
    database: keepa
    # ... æ›´å¤šé…ç½®
```

### åœ¨ä»»åŠ¡ä¸­ä½¿ç”¨æ•°æ®åº“

```go
import "keepa/internal/database"

func (t *MyTask) Run(ctx context.Context) error {
    // è·å– MySQL è¿æ¥
    mysqlDB, err := database.GetMySQL()
    if err == nil {
        // ä½¿ç”¨ MySQL...
    }
    
    // è·å– PostgreSQL è¿æ¥
    pgDB, err := database.GetPostgreSQL()
    if err == nil {
        // ä½¿ç”¨ PostgreSQL...
    }
    
    // è·å– MongoDB è¿æ¥
    mongoDB, err := database.GetMongoDB()
    if err == nil {
        // ä½¿ç”¨ MongoDB...
    }
    
    return nil
}
```

è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜å’Œç¤ºä¾‹ï¼Œè¯·å‚è€ƒ [æ•°æ®åº“ä½¿ç”¨æŒ‡å—](./docs/DATABASE.md)ã€‚

## å¼€å‘å»ºè®®

1. **ä»»åŠ¡è®¾è®¡**: æ¯ä¸ªä»»åŠ¡åº”è¯¥æ˜¯ç‹¬ç«‹çš„ã€å¯æµ‹è¯•çš„å•å…ƒ
2. **é”™è¯¯å¤„ç†**: ä»»åŠ¡åº”è¯¥è¿”å›æœ‰æ„ä¹‰çš„é”™è¯¯ä¿¡æ¯
3. **è¶…æ—¶æ§åˆ¶**: ä¸ºé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡è®¾ç½®åˆé€‚çš„è¶…æ—¶æ—¶é—´
4. **æ—¥å¿—è®°å½•**: ä½¿ç”¨ç»“æ„åŒ–çš„æ—¥å¿—è®°å½•ä»»åŠ¡æ‰§è¡Œæƒ…å†µ
5. **èµ„æºæ¸…ç†**: ç¡®ä¿ä»»åŠ¡æ­£ç¡®é‡Šæ”¾èµ„æºï¼ˆæ•°æ®åº“è¿æ¥ã€æ–‡ä»¶å¥æŸ„ç­‰ï¼‰

## å‘½ä»¤è¯´æ˜

- `make deps` - ä¸‹è½½ä¾èµ–
- `make fmt` - æ ¼å¼åŒ–ä»£ç 
- `make vet` - è¿è¡Œ go vet
- `make test` - è¿è¡Œæµ‹è¯•
- `make build` - æ„å»ºåº”ç”¨
- `make run` - æ„å»ºå¹¶è¿è¡Œ
- `make clean` - æ¸…ç†æ„å»ºæ–‡ä»¶

## è®¸å¯è¯

MIT License

